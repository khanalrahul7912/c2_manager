{% extends 'base.html' %}
{% block title %}Host {{ host.name }}{% endblock %}
{% block content %}
<section class="card">
  <div class="card-header">
    <h2>{{ host.name }}</h2>
    <div class="toolbar">
      <a href="{{ url_for('main.edit_host', host_id=host.id) }}" class="btn ghost">Edit</a>
      <button type="button" class="btn ghost" id="btn-disconnect" title="Close SSH session">‚èè Disconnect</button>
      <a href="{{ url_for('main.unified_dashboard', view='ssh') }}" class="btn ghost">Back to Hosts</a>
    </div>
  </div>
  <div class="host-info-bar">
    <span class="info-item"><strong>Endpoint:</strong> <code>{{ host.username }}@{{ host.address }}:{{ host.port }}</code></span>
    <span class="info-item"><strong>Group:</strong> {{ host.group_name }}</span>
    <span class="info-item"><strong>Auth:</strong> {{ host.auth_mode }}</span>
    {% if host.use_jump_host %}
    <span class="info-item"><strong>Jump:</strong> <code>{{ host.jump_username }}@{{ host.jump_address }}:{{ host.jump_port }}</code></span>
    {% endif %}
  </div>
</section>

{# Disconnect warning banner (hidden initially) #}
<div class="term-disconnect-banner" id="term-disconnect-banner" style="display:none">
  <span class="warn-icon">‚ö†Ô∏è</span>
  <span class="warn-text">
    <strong>SSH session disconnected</strong>
    <small>Click "üîÑ Reconnect" to start a new session.</small>
  </span>
</div>

{# Real-time xterm.js terminal #}
<div class="term-wrap">
  <div class="term-titlebar">
    <div class="term-dots"><span class="d-r"></span><span class="d-y"></span><span class="d-g"></span></div>
    <span class="term-title">{{ host.username }}@{{ host.address }}:{{ host.port }} ‚Äî SSH</span>
    <span class="term-status">
      <span class="term-dot online" id="term-status-dot"></span>
      <span id="term-status-text">Connecting‚Ä¶</span>
    </span>
    <div class="term-actions">
      <button type="button" id="btn-reconnect" title="Reconnect SSH session">üîÑ Reconnect</button>
      <button type="button" id="btn-copy" title="Copy terminal output">üìã Copy</button>
    </div>
  </div>
  <div id="xterm-container" style="background:#1a1b26;"></div>
</div>

{% if old_executions %}
<section class="card" style="margin-top:1rem;">
  <div class="card-header">
    <h3>Command History (older sessions)</h3>
  </div>
  <div class="terminal-history">
    <div class="terminal-history-body">
      {% for run in old_executions %}
      <div class="terminal-entry">
        <div class="terminal-entry-meta">
          <span class="pill {{ run.status }}">{{ run.status }}</span>
          <span>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <div class="terminal-prompt">{{ run.command }}</div>
        {% if run.stdout %}<div class="terminal-stdout">{{ run.stdout }}</div>{% endif %}
        {% if run.stderr %}<div class="terminal-stderr">{{ run.stderr }}</div>{% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{# xterm.js local vendor files #}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/xterm.css') }}">
<script src="{{ url_for('static', filename='vendor/xterm.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/addon-fit.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/addon-web-links.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/socket.io.min.js') }}"></script>
<script>
(function() {
  'use strict';

  const HOST_ID = {{ host.id }};

  /* ‚îÄ‚îÄ xterm.js setup ‚îÄ‚îÄ */
  const term = new window.Terminal({
    cursorBlink: true,
    fontSize: 14,
    fontFamily: "'SF Mono', Monaco, Menlo, 'Courier New', monospace",
    theme: {
      background: '#1a1b26',
      foreground: '#c0caf5',
      cursor: '#c0caf5',
      selectionBackground: '#33467c',
      black: '#15161e', red: '#f7768e', green: '#9ece6a', yellow: '#e0af68',
      blue: '#7aa2f7', magenta: '#bb9af7', cyan: '#7dcfff', white: '#a9b1d6',
    },
    scrollback: 10000,
    allowProposedApi: true,
  });

  const fitAddon = new window.FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  try {
    const webLinksAddon = new window.WebLinksAddon.WebLinksAddon();
    term.loadAddon(webLinksAddon);
  } catch(e) {}

  const container = document.getElementById('xterm-container');
  term.open(container);
  fitAddon.fit();

  window.addEventListener('resize', function() { fitAddon.fit(); });

  /* ‚îÄ‚îÄ Status UI ‚îÄ‚îÄ */
  const statusDot = document.getElementById('term-status-dot');
  const statusText = document.getElementById('term-status-text');
  const banner = document.getElementById('term-disconnect-banner');

  function setStatus(connected) {
    if (statusDot) statusDot.className = 'term-dot ' + (connected ? 'online' : 'offline');
    if (statusText) statusText.textContent = connected ? 'Connected' : 'Disconnected';
    if (banner) banner.style.display = connected ? 'none' : 'flex';
  }

  /* ‚îÄ‚îÄ SocketIO ‚îÄ‚îÄ */
  const socket = io({ transports: ['websocket', 'polling'] });
  let connected = false;

  function connectSSH() {
    term.write('\r\nConnecting to {{ host.username }}@{{ host.address }}:{{ host.port }}...\r\n');
    socket.emit('ssh_connect', {
      host_id: HOST_ID,
      cols: term.cols,
      rows: term.rows,
    });
  }

  socket.on('connect', function() {
    connectSSH();
  });

  socket.on('shell_output', function(data) {
    if (data.data) {
      term.write(data.data);
    }
  });

  socket.on('shell_status', function(data) {
    connected = data.connected;
    setStatus(connected);
  });

  /* Send user input to SSH channel */
  term.onData(function(data) {
    if (connected) {
      socket.emit('ssh_input', { data: data });
    }
  });

  /* Terminal resize ‚Üí SSH PTY resize */
  term.onResize(function(size) {
    if (connected) {
      socket.emit('ssh_resize', { cols: size.cols, rows: size.rows });
    }
  });

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  document.getElementById('btn-disconnect').addEventListener('click', function() {
    if (confirm('Disconnect this SSH session?')) {
      socket.emit('ssh_disconnect_host', { host_id: HOST_ID });
      connected = false;
      setStatus(false);
    }
  });

  document.getElementById('btn-reconnect').addEventListener('click', function() {
    term.write('\r\n--- Reconnecting ---\r\n');
    connectSSH();
  });

  document.getElementById('btn-copy').addEventListener('click', function() {
    const text = (function() {
      let lines = [];
      for (let i = 0; i < term.buffer.active.length; i++) {
        const line = term.buffer.active.getLine(i);
        if (line) lines.push(line.translateToString(true));
      }
      return lines.join('\n');
    })();
    navigator.clipboard.writeText(text).then(function() {
      const btn = document.getElementById('btn-copy');
      const orig = btn.textContent;
      btn.textContent = '‚úì Copied!';
      setTimeout(function() { btn.textContent = orig; }, 1500);
    });
  });
})();
</script>
{% endblock %}
