{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% block content %}
<section class="card">
  <div class="card-header"><h2>⚙️ Settings</h2></div>

  <div class="settings-section">
    <h3>Profile</h3>
    <div class="host-info-bar">
      <span class="info-item"><strong>User:</strong> {{ current_user.username }}</span>
      <span class="info-item"><strong>Role:</strong> {{ current_user.role }}</span>
      <span class="info-item"><strong>Since:</strong> {{ current_user.created_at.strftime('%Y-%m-%d') }}</span>
    </div>
  </div>

  <div class="settings-section">
    <h3>Change Password</h3>
    <form method="POST" style="max-width: 350px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="action" value="change_password">
      <label for="new_password">New Password
        <input type="password" id="new_password" name="new_password" required minlength="8">
      </label>
      <label for="confirm_password">Confirm Password
        <input type="password" id="confirm_password" name="confirm_password" required minlength="8">
      </label>
      <button type="submit" class="btn primary" style="margin-top: 0.5rem;">Update Password</button>
    </form>
  </div>

  {% if current_user.role == 'admin' %}
  <div class="settings-section">
    <h3>User Management</h3>
    <table class="user-table">
      <thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.username }}</td>
          <td><span class="pill {% if user.role == 'admin' %}success{% endif %}">{{ user.role }}</span></td>
          <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
          <td>
            {% if user.id != current_user.id %}
            <form method="POST" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="delete_user">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <button type="submit" class="btn danger" onclick="return confirm('Delete user {{ user.username }}?')">Delete</button>
            </form>
            <form method="POST" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="toggle_role">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <button type="submit" class="btn ghost">{% if user.role == 'admin' %}→ Operator{% else %}→ Admin{% endif %}</button>
            </form>
            {% else %}
            <span style="color:var(--text-muted);font-size:0.72rem;">Current user</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 style="margin-top:1rem;">Create User</h3>
    <form method="POST" style="max-width: 350px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="action" value="create_user">
      <label for="new_username">Username
        <input type="text" id="new_username" name="new_username" required minlength="3">
      </label>
      <label for="user_password">Password
        <input type="password" id="user_password" name="user_password" required minlength="8">
      </label>
      <label for="user_role">Role
        <select id="user_role" name="user_role">
          <option value="operator">Operator</option>
          <option value="admin">Admin</option>
        </select>
      </label>
      <button type="submit" class="btn primary" style="margin-top: 0.5rem;">Create User</button>
    </form>
  </div>
  {% endif %}
</section>
{% endblock %}
