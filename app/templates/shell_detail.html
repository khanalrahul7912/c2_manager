{% extends 'base.html' %}
{% block title %}{{ shell.name }}{% endblock %}
{% block content %}
<section class="card">
  <div class="card-header">
    <h2>Shell: {{ shell.name }}</h2>
    <div class="toolbar">
      {% if current_user.role == 'admin' %}
      <a href="{{ url_for('main.edit_shell', shell_id=shell.id) }}" class="btn ghost">Edit</a>
      {% endif %}
      <a href="{{ url_for('main.shells_dashboard') }}" class="btn ghost">Back to Shells</a>
    </div>
  </div>

  <div class="host-info-bar">
    <span class="info-item"><strong>Address:</strong> <code>{{ shell.address }}:{{ shell.port }}</code></span>
    <span class="info-item"><strong>Group:</strong> {{ shell.group_name }}</span>
    <span class="info-item"><strong>Platform:</strong> {{ shell.platform or 'Unknown' }}</span>
    <span class="info-item"><strong>Hostname:</strong> {{ shell.hostname or '-' }}</span>
  </div>
</section>

{# Disconnect warning banner (hidden when connected) #}
<div class="term-disconnect-banner" id="term-disconnect-banner" {% if is_connected %}style="display:none"{% endif %}>
  <span class="warn-icon">‚ö†Ô∏è</span>
  <span class="warn-text">
    <strong>Shell is disconnected</strong>
    <small>Commands cannot be executed. The terminal will resume automatically when the shell reconnects.</small>
  </span>
</div>

{# Interactive terminal #}
<div class="term-wrap">
  <div class="term-titlebar">
    <div class="term-dots"><span class="d-r"></span><span class="d-y"></span><span class="d-g"></span></div>
    <span class="term-title">{{ shell.shell_user or 'shell' }}@{{ shell.hostname or shell.address }} ‚Äî Reverse Shell</span>
    <span class="term-status">
      <span class="term-dot {% if is_connected %}online{% else %}offline{% endif %}" id="term-status-dot"></span>
      <span id="term-status-text">{% if is_connected %}Connected{% else %}Disconnected{% endif %}</span>
    </span>
    <div class="term-actions">
      <button type="button" onclick="document.getElementById('term-body').innerHTML=''" title="Clear (Ctrl+L)">üßπ Clear</button>
      <button type="button" onclick="copyTerminalOutput(this)" title="Copy all output">üìã Copy</button>
    </div>
  </div>

  <div class="term-body" id="term-body">
    {# Render recent command history (newest first, reversed to oldest-first display) #}
    {% for run in executions | reverse %}
    <div><span class="term-prompt-label">{{ shell.shell_user or 'shell' }}@{{ shell.hostname or shell.address }}$</span> <span class="term-cmd">{{ run.command }}</span></div>
    {% if run.output %}<div><span class="term-stdout">{{ run.output }}</span></div>{% endif %}
    {% if run.stderr %}<div><span class="term-stderr">{{ run.stderr }}</span></div>{% endif %}
    {% endfor %}
  </div>

  <form class="term-inputbar" id="term-form" autocomplete="off">
    <span class="prompt-label">{{ shell.shell_user or 'shell' }}@{{ shell.hostname or shell.address }}$</span>
    <input type="text" id="term-input" placeholder="Type a command‚Ä¶" {% if not is_connected %}disabled{% endif %} autocomplete="off" autofocus>
  </form>
</div>

<script>
  window.TERMINAL_CONFIG = {
    executeUrl:   '{{ url_for("main.shell_execute_api", shell_id=shell.id) }}',
    statusUrl:    '{{ url_for("main.shell_status_api", shell_id=shell.id) }}',
    historyUrl:   '{{ url_for("main.reverse_history_api", shell_id=shell.id) }}',
    shellType:    'reverse',
    promptLabel:  '{{ shell.shell_user or "shell" }}@{{ shell.hostname or shell.address }}$',
    isConnected:  {{ 'true' if is_connected else 'false' }},
    csrfToken:    '{{ csrf_token() }}',
    totalHistory: {{ total_history }},
    loadedHistory: {{ loaded_history }},
  };
</script>
<script src="{{ url_for('static', filename='js/terminal.js') }}"></script>
{% endblock %}
