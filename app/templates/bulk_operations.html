{% extends 'base.html' %}
{% block title %}Bulk operations{% endblock %}
{% block content %}
<section class="card">
  <h2>Bulk command execution (SSH)</h2>
  <form method="post">
    {{ form.hidden_tag() }}
    <label>{{ form.host_ids.label }}
      {{ form.host_ids(size=12, class_='multi-select') }}
    </label>
    <label>{{ form.command.label }} {{ form.command(rows=4, placeholder='uptime') }}</label>
    {{ form.submit(class_='btn') }}
  </form>
</section>

<section class="card">
  <h3>Recent operations</h3>
  <div class="toolbar" style="margin-bottom: 1rem;">
    <a href="{{ url_for('main.export_ssh_executions') }}" class="btn ghost">Export CSV</a>
  </div>
  <table>
    <thead><tr><th>Host</th><th>Status</th><th>Started</th><th>Command</th><th>stderr</th></tr></thead>
    <tbody>
      {% for run in recent_bulk %}
      <tr>
        <td>{{ run.host.name }}</td>
        <td><span class="pill {{ run.status }}">{{ run.status }}</span></td>
        <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td><code>{{ run.command }}</code></td>
        <td><code>{{ run.stderr[:140] }}</code></td>
      </tr>
      {% else %}
      <tr><td colspan="5">No operation history yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pagination-row">
    {% if runs_pagination.has_prev %}
    <a class="btn ghost" href="{{ url_for('main.bulk_operations', page=runs_pagination.prev_num) }}">Prev</a>
    {% endif %}
    <span>Page {{ runs_pagination.page }} / {{ runs_pagination.pages or 1 }}</span>
    {% if runs_pagination.has_next %}
    <a class="btn ghost" href="{{ url_for('main.bulk_operations', page=runs_pagination.next_num) }}">Next</a>
    {% endif %}
  </div>
</section>
{% endblock %}
