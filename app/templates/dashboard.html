{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<section class="grid two-col">
  <article class="card">
    <div class="card-header">
      <h2>Managed Hosts</h2>
      <div class="toolbar">
        {% if current_user.role == 'admin' %}
        <a class="btn" href="{{ url_for('main.create_host') }}">Add host</a>
        {% endif %}
        <a class="btn ghost" href="{{ url_for('main.bulk_operations') }}">Bulk ops</a>
      </div>
    </div>

    <form method="get" class="inline-form">
      <label>Filter by group
        <select name="group" onchange="this.form.submit()">
          <option value="">All groups</option>
          {% for group in groups %}
            <option value="{{ group }}" {% if selected_group == group %}selected{% endif %}>{{ group }}</option>
          {% endfor %}
        </select>
      </label>
      <input type="hidden" name="host_page" value="1">
      <input type="hidden" name="run_page" value="1">
    </form>

    <table>
      <thead>
        <tr><th>Name</th><th>Group</th><th>Endpoint</th><th>Auth</th><th>Jump</th><th>Status</th><th></th></tr>
      </thead>
      <tbody>
        {% for host in hosts %}
        <tr>
          <td>{{ host.name }}</td>
          <td>{{ host.group_name }}</td>
          <td>{{ host.username }}@{{ host.address }}:{{ host.port }}</td>
          <td>{{ host.auth_mode }}</td>
          <td>{{ 'yes' if host.use_jump_host else 'no' }}</td>
          <td>{{ 'active' if host.is_active else 'disabled' }}</td>
          <td>
            <a href="{{ url_for('main.host_detail', host_id=host.id) }}">Open</a>
            {% if current_user.role == 'admin' %}
            | <a href="{{ url_for('main.edit_host', host_id=host.id) }}">Edit</a>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7">No hosts configured.</td></tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination-row">
      {% if hosts_pagination.has_prev %}
      <a class="btn ghost" href="{{ url_for('main.dashboard', group=selected_group, host_page=hosts_pagination.prev_num, run_page=runs_pagination.page) }}">Prev hosts</a>
      {% endif %}
      <span>Hosts page {{ hosts_pagination.page }} / {{ hosts_pagination.pages or 1 }}</span>
      {% if hosts_pagination.has_next %}
      <a class="btn ghost" href="{{ url_for('main.dashboard', group=selected_group, host_page=hosts_pagination.next_num, run_page=runs_pagination.page) }}">Next hosts</a>
      {% endif %}
    </div>
  </article>

  <article class="card">
    <h2>Recent command executions</h2>
    <table>
      <thead><tr><th>Host</th><th>User</th><th>Status</th><th>Start</th><th>Command</th></tr></thead>
      <tbody>
      {% for run in recent_commands %}
      <tr>
        <td>{{ run.host.name }}</td>
        <td>{{ run.user.username }}</td>
        <td><span class="pill {{ run.status }}">{{ run.status }}</span></td>
        <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td><code>{{ run.command }}</code></td>
      </tr>
      {% else %}
      <tr><td colspan="5">No executions yet.</td></tr>
      {% endfor %}
      </tbody>
    </table>
    <div class="pagination-row">
      {% if runs_pagination.has_prev %}
      <a class="btn ghost" href="{{ url_for('main.dashboard', group=selected_group, host_page=hosts_pagination.page, run_page=runs_pagination.prev_num) }}">Prev runs</a>
      {% endif %}
      <span>Runs page {{ runs_pagination.page }} / {{ runs_pagination.pages or 1 }}</span>
      {% if runs_pagination.has_next %}
      <a class="btn ghost" href="{{ url_for('main.dashboard', group=selected_group, host_page=hosts_pagination.page, run_page=runs_pagination.next_num) }}">Next runs</a>
      {% endif %}
    </div>
  </article>
</section>
{% endblock %}
